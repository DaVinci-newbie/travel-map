<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”ä¸€ç›®çš„åœ°æŠ½ç­¾</title>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; height: 100vh; }
        #container { display: flex; flex-direction: column; height: 100%; }
        #map { flex: 1; width: 100%; }
        #controls { padding: 15px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        button { width: 100%; padding: 12px; background: #4D6BFF; color: white; border: none; border-radius: 5px; margin-bottom: 10px; }
        .result { font-size: 14px; line-height: 1.6; padding: 10px 0; }
        .error { color: #FF6B00; font-weight: bold; }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="controls">
            <button onclick="fetchRandomSpot()">ğŸ² éšæœºæ¨èæ™¯ç‚¹</button>
            <div id="result">æ­£åœ¨åˆå§‹åŒ–åœ°å›¾...</div>
        </div>
    </div>

    <!-- é«˜å¾·åœ°å›¾API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=9de5d8be2e64bfcd3d709e37df3bd8b6&plugin=AMap.PlaceSearch,AMap.Geolocation"></script>
    <script>
        // é…ç½®å‚æ•°
        const CONFIG = {
            amapKey: "9de5d8be2e64bfcd3d709e37df3bd8b6", // æ›¿æ¢ä¸ºä½ çš„é«˜å¾·Key
            defaultTypes: "é£æ™¯åèƒœ|å…¬å›­|åšç‰©é¦†",
            defaultCity: "å…¨å›½",
            searchRadius: 5000 // å‘¨è¾¹æœç´¢åŠå¾„(ç±³)
        };

        // å…¨å±€å˜é‡
        let map, amapSpots = [], currentMarker = null;

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = new AMap.Map('map', {
                zoom: 5,
                center: [116.397, 39.918],
                viewMode: '2D'
            });

            // æ·»åŠ æ§ä»¶
            AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
                map.addControl(new AMap.ToolBar());
                map.addControl(new AMap.Scale());
            });

            // åŠ è½½åˆå§‹æ•°æ®
            loadDefaultSpots();
        }

        // åŠ è½½é»˜è®¤æ™¯ç‚¹æ•°æ®
        function loadDefaultSpots() {
            document.getElementById('result').innerHTML = "æ­£åœ¨åŠ è½½æ™¯ç‚¹æ•°æ®...";
            
            const placeSearch = new AMap.PlaceSearch({
                city: CONFIG.defaultCity,
                type: CONFIG.defaultTypes,
                pageSize: 30
            });

            placeSearch.search('å…¬å›­', (status, result) => {
                if (status === 'complete' && result.poiList && result.poiList.pois) {
                    amapSpots = result.poiList.pois;
                    document.getElementById('result').innerHTML = 
                        `å·²åŠ è½½${amapSpots.length}ä¸ªæ™¯ç‚¹ï¼Œç‚¹å‡»æŒ‰é’®éšæœºæ¨è`;
                    fetchRandomSpot();
                } else {
                    showError("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¯†é’¥é…ç½®");
                }
            });
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(msg) {
            document.getElementById('result').innerHTML = 
                `<span class="error">${msg}</span>`;
            console.error(msg);
        }

        // éšæœºæ¨èæ™¯ç‚¹
        function fetchRandomSpot() {
            if (amapSpots.length === 0) {
                showError("æš‚æ— æ™¯ç‚¹æ•°æ®ï¼Œè¯·å…ˆåŠ è½½");
                return;
            }
            
            const spot = amapSpots[Math.floor(Math.random() * amapSpots.length)];
            showSpot(spot);
        }

        // æ˜¾ç¤ºæ™¯ç‚¹è¯¦æƒ…
        function showSpot(spot) {
            // æ¸…é™¤æ—§æ ‡è®°
            if (currentMarker) map.remove(currentMarker);
            
            // åˆ›å»ºæ–°æ ‡è®°
            currentMarker = new AMap.Marker({
                position: [spot.location.lng, spot.location.lat],
                content: `<div style="background:#FF6B00;color:white;padding:5px 10px;border-radius:15px">
                    ${spot.name}
                </div>`
            });
            map.add(currentMarker);
            map.setCenter([spot.location.lng, spot.location.lat]);
            
            // æ˜¾ç¤ºè¯¦æƒ…
            let info = `<b>${spot.name}</b><br>åœ°å€ï¼š${spot.address}`;
            if (spot.tel) info += `<br>ç”µè¯ï¼š${spot.tel}`;
            document.getElementById('result').innerHTML = info;
        }

        // å®šä½ç”¨æˆ·ä½ç½®
        function locateUser() {
            document.getElementById('result').innerHTML = "æ­£åœ¨è·å–ä½ç½®...";
            
            const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 5000
            });
            
            geolocation.getCurrentPosition((status, result) => {
                if (status === 'complete') {
                    const lnglat = [result.position.lng, result.position.lat];
                    map.setCenter(lnglat);
                    map.setZoom(15);
                    
                    // æ˜¾ç¤ºä½ç½®æ ‡è®°
                    if (currentMarker) map.remove(currentMarker);
                    currentMarker = new AMap.Marker({
                        position: lnglat,
                        content: '<div style="background:#4D6BFF;color:white;padding:5px;border-radius:50%">ğŸ“</div>'
                    });
                    map.add(currentMarker);
                    
                    // æœç´¢å‘¨è¾¹æ™¯ç‚¹
                    searchNearbySpots(lnglat);
                } else {
                    showError("å®šä½å¤±è´¥ï¼š" + (result.message || "è¯·æ£€æŸ¥å®šä½æƒé™"));
                }
            });
        }

        // æœç´¢å‘¨è¾¹æ™¯ç‚¹
        function searchNearbySpots(lnglat) {
            document.getElementById('result').innerHTML = "æ­£åœ¨æœç´¢å‘¨è¾¹æ™¯ç‚¹...";
            
            const placeSearch = new AMap.PlaceSearch({
                type: CONFIG.defaultTypes,
                pageSize: 20
            });
            
            placeSearch.searchNearBy('', lnglat, CONFIG.searchRadius, (status, result) => {
                if (status === 'complete' && result.poiList && result.poiList.pois) {
                    amapSpots = result.poiList.pois;
                    document.getElementById('result').innerHTML = 
                        `æ‰¾åˆ°${amapSpots.length}ä¸ªå‘¨è¾¹æ™¯ç‚¹`;
                    fetchRandomSpot();
                } else {
                    showError("å‘¨è¾¹æ™¯ç‚¹æœç´¢å¤±è´¥");
                }
            });
        }

        // å¾®ä¿¡ç¯å¢ƒåˆå§‹åŒ–
        if (/MicroMessenger/i.test(navigator.userAgent)) {
            document.addEventListener('WeixinJSBridgeReady', initMap, false);
            // è§£å†³å¾®ä¿¡åœ°å›¾æ‹–åŠ¨é—®é¢˜
            document.body.style['touch-action'] = 'none';
        } else {
            window.onload = initMap;
        }
    </script>
</body>
</html>
